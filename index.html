<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPAN - Registre d'Allaus</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 15px; max-width: 500px; margin: auto; }
        
        #map { height: 300px; width: 100%; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ddd; z-index: 1; }
        
        .camp { margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
        
        .btn { padding: 15px; font-size: 16px; border: none; border-radius: 8px; width: 100%; cursor: pointer; color: white; font-weight: bold; margin-bottom: 10px; }
        .btn-gps { background-color: #3498db; }
        .btn-guardar { background-color: #f39c12; }
        .btn-sync { background-color: #2e7d32; display: none; }
        
        #coords-info { font-size: 12px; color: #555; text-align: center; margin-bottom: 15px; }
        
        /* Estils de la llista de pendents */
        .caixa-llista { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; }
        .registre { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px; font-size: 14px; }
    </style>
</head>
<body>

    <h2>üèîÔ∏è Reportar Allau (UPAN)</h2>

    <div id="map"></div>
    <button id="btn-gps" class="btn btn-gps">üìç Capturar la meva ubicaci√≥</button>
    <div id="coords-info">Coordenades no capturades encara.</div>

    <div class="camp">
        <label>Nom del sector / Lloc:</label>
        <input type="text" id="input-lloc" placeholder="Ex: Pala d'Eixe">
    </div>
    <div class="camp">
        <label>Mida de l'allau:</label>
        <select id="input-mida">
            <option value="D1">D1 (Petita)</option>
            <option value="D2">D2 (Mitjana)</option>
            <option value="D3">D3 (Gran)</option>
        </select>
    </div>

    <button id="btn-guardar" class="btn btn-guardar">üíæ Guardar al Tel√®fon (Offline)</button>

    <div class="caixa-llista">
        <h3>Pendents d'enviar: <span id="comptador">0</span></h3>
        <div id="llista-registres"></div>
        <button id="btn-sync" class="btn btn-sync">üì° Sincronitzar amb Servidor</button>
    </div>

    <script>
        // Variables globals
        let latitudActual = null;
        let longitudActual = null;
        let marcador;

        // 1. INICIALITZAR EL MAPA
        const map = L.map('map').setView([42.5, 1.5], 8);
        L.tileLayer('https://geoserveis.icgc.cat/servei/catalunya/mapa-base/wmts/topografic/MON3857NW/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© ICGC'
        }).addTo(map);

        setTimeout(() => { map.invalidateSize(); }, 500);

        // 2. FUNCI√ì PER CAPTURAR EL GPS
        document.getElementById('btn-gps').addEventListener('click', () => {
            const infoDiv = document.getElementById('coords-info');
            if (!navigator.geolocation) {
                infoDiv.innerHTML = "<span style='color:red;'>Navegador no suportat.</span>";
                return;
            }
            infoDiv.innerText = "Buscant sat√®l¬∑lits... üõ∞Ô∏è (Pot trigar sense internet)";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    latitudActual = position.coords.latitude;
                    longitudActual = position.coords.longitude;
                    
                    infoDiv.innerHTML = `‚úÖ Lat: ${latitudActual.toFixed(5)}, Lon: ${longitudActual.toFixed(5)}`;
                    map.setView([latitudActual, longitudActual], 15);

                    if (marcador) map.removeLayer(marcador);
                    marcador = L.marker([latitudActual, longitudActual]).addTo(map);
                },
                (error) => {
                    infoDiv.innerHTML = `<span style='color:red;'>Error de GPS.</span>`;
                },
                { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
            );
        });

        // ==========================================
        // L√íGICA OFFLINE (LOCALSTORAGE) RECUPERADA
        // ==========================================
        const llistaRegistres = document.getElementById('llista-registres');
        const comptador = document.getElementById('comptador');
        const btnSync = document.getElementById('btn-sync');

        function carregarDadesLocals() {
            const dades = JSON.parse(localStorage.getItem('allaus_pendents')) || [];
            llistaRegistres.innerHTML = '';
            
            dades.forEach((allau, index) => {
                llistaRegistres.innerHTML += `
                    <div class="registre">
                        <strong>#${index + 1} - ${allau.lloc}</strong> (Mida: ${allau.mida})<br>
                        <small>Coords: ${allau.lat.toFixed(4)}, ${allau.lon.toFixed(4)}</small>
                    </div>
                `;
            });

            comptador.innerText = dades.length;
            if (dades.length > 0) {
                btnSync.style.display = 'block';
            } else {
                btnSync.style.display = 'none';
                llistaRegistres.innerHTML = '<p style="color:gray; font-size:12px;">Cap allau pendent.</p>';
            }
        }

        // 3. GUARDAR REAL
        document.getElementById('btn-guardar').addEventListener('click', () => {
            const lloc = document.getElementById('input-lloc').value;
            const mida = document.getElementById('input-mida').value;

            if (latitudActual === null) {
                alert("Si us plau, captura primer la ubicaci√≥."); return;
            }
            if (lloc === "") {
                alert("Escriu el nom del sector."); return;
            }

            const novaAllau = {
                lloc: lloc,
                mida: mida,
                lat: latitudActual,
                lon: longitudActual,
                data: new Date().toLocaleString()
            };

            const dades = JSON.parse(localStorage.getItem('allaus_pendents')) || [];
            dades.push(novaAllau);
            localStorage.setItem('allaus_pendents', JSON.stringify(dades));

            // Netegem l'estat per a la seg√ºent allau
            document.getElementById('input-lloc').value = "";
            latitudActual = null;
            longitudActual = null;
            document.getElementById('coords-info').innerText = "Coordenades no capturades encara.";
            if (marcador) map.removeLayer(marcador);
            
            carregarDadesLocals();
            alert("‚úÖ Guardat al tel√®fon! Ho tens pendent d'enviar.");
        });

        // 4. SINCRONITZAR
        btnSync.addEventListener('click', () => {
            if (!navigator.onLine) {
                alert("‚ùå No tens internet per sincronitzar."); return;
            }
            btnSync.innerText = "‚è≥ Enviant...";
            
            setTimeout(() => {
                localStorage.removeItem('allaus_pendents');
                carregarDadesLocals();
                btnSync.innerText = "üì° Sincronitzar amb Servidor";
                alert("üöÄ Dades enviades!");
            }, 1500);
        });

        carregarDadesLocals();

        // 5. SERVICE WORKER
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
