<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPAN - Registre d'Allaus</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 15px; max-width: 500px; margin: auto; }
        #map { height: 300px; width: 100%; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ddd; z-index: 1; }
        .camp { margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; background-color: white; }
        
        .btn { padding: 15px; font-size: 16px; border: none; border-radius: 8px; width: 100%; cursor: pointer; color: white; font-weight: bold; margin-bottom: 10px; }
        .btn-gps { background-color: #3498db; }
        .btn-guardar { background-color: #f39c12; }
        .btn-sync { background-color: #2e7d32; display: none; }
        
        /* Bot√≥ de la c√†mera (ajustat com els altres) */
        .btn-foto { 
            background-color: #9b59b6; 
            display: block; 
            box-sizing: border-box; 
            text-align: center; 
        }
        
        #coords-info { font-size: 12px; color: #555; text-align: center; margin-bottom: 15px; }
        #preview-foto { display: none; width: 100%; margin-top: 10px; border-radius: 8px; border: 2px dashed #9b59b6; }
        
        input[type="file"] { display: none; }
        
        .caixa-llista { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; }
        .registre { border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; font-size: 14px; display: flex; align-items: center; gap: 15px; }
        .registre img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <h2>üèîÔ∏è Reportar Allau (UPAN)</h2>

    <div id="map"></div>
    <button id="btn-gps" class="btn btn-gps">üìç Capturar la meva ubicaci√≥</button>
    <div id="coords-info">Coordenades no capturades encara.</div>

    <div class="camp">
        <label>Nom del sector / Lloc:</label>
        <input type="text" id="input-lloc" placeholder="Ex: Pala d'Eixe">
    </div>
    
    <div class="camp">
        <label>Mida de l'allau:</label>
        <select id="input-mida">
            <option value="D1">D1</option>
            <option value="D2">D2</option>
            <option value="D3">D3</option>
            <option value="D4">D4</option>
            <option value="D5">D5</option>
        </select>
    </div>

    <div class="camp">
        <label>Tipus d'allau:</label>
        <select id="input-tipus">
            <option value="Placa de vent">Placa de vent</option>
            <option value="Lliscament basal">Lliscament basal</option>
            <option value="Neu humida">Neu humida</option>
            <option value="Neu recent">Neu recent</option>
            <option value="Neu ventada">Neu ventada</option>
        </select>
    </div>

    <div class="camp">
        <label class="btn btn-foto" for="input-foto">üì∑ Fer Fotografia</label>
        <input type="file" id="input-foto" accept="image/*" capture="environment">
        <img id="preview-foto" src="" alt="Previsualitzaci√≥">
    </div>

    <button id="btn-guardar" class="btn btn-guardar">üíæ Guardar al Tel√®fon (Offline)</button>

    <div class="caixa-llista">
        <h3>Pendents d'enviar: <span id="comptador">0</span></h3>
        <div id="llista-registres"></div>
        <button id="btn-sync" class="btn btn-sync">üì° Sincronitzar amb Servidor</button>
    </div>

    <script>
        let latitudActual = null;
        let longitudActual = null;
        let fotoBase64 = null; 
        let marcador;

        const map = L.map('map').setView([42.5, 1.5], 8);
        L.tileLayer('https://geoserveis.icgc.cat/servei/catalunya/mapa-base/wmts/topografic/MON3857NW/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© ICGC'
        }).addTo(map);

        setTimeout(() => { map.invalidateSize(); }, 500);

        // --- GPS ---
        document.getElementById('btn-gps').addEventListener('click', () => {
            const infoDiv = document.getElementById('coords-info');
            if (!navigator.geolocation) return;
            infoDiv.innerText = "Buscant sat√®l¬∑lits... üõ∞Ô∏è";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    latitudActual = position.coords.latitude;
                    longitudActual = position.coords.longitude;
                    infoDiv.innerHTML = `‚úÖ Lat: ${latitudActual.toFixed(5)}, Lon: ${longitudActual.toFixed(5)}`;
                    map.setView([latitudActual, longitudActual], 15);
                    if (marcador) map.removeLayer(marcador);
                    marcador = L.marker([latitudActual, longitudActual]).addTo(map);
                },
                (error) => { infoDiv.innerHTML = `<span style='color:red;'>Error de GPS.</span>`; },
                { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
            );
        });

        // --- FOTOGRAFIA ---
        document.getElementById('input-foto').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fotoBase64 = e.target.result; 
                    const preview = document.getElementById('preview-foto');
                    preview.src = fotoBase64;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // --- L√íGICA OFFLINE ---
        const llistaRegistres = document.getElementById('llista-registres');
        const comptador = document.getElementById('comptador');
        const btnSync = document.getElementById('btn-sync');

        async function carregarDadesLocals() {
            const dades = await localforage.getItem('allaus_pendents') || [];
            llistaRegistres.innerHTML = '';
            
            dades.forEach((allau, index) => {
                const imgTag = allau.foto ? `<img src="${allau.foto}" alt="Miniatura">` : '';
                
                // Ara mostrem el Tipus al costat de la Mida
                llistaRegistres.innerHTML += `
                    <div class="registre">
                        ${imgTag}
                        <div>
                            <strong>#${index + 1} - ${allau.lloc}</strong><br>
                            <small>Mida: ${allau.mida} | Tipus: ${allau.tipus}</small><br>
                            <small>Coords: ${allau.lat.toFixed(4)}, ${allau.lon.toFixed(4)}</small>
                        </div>
                    </div>
                `;
            });

            comptador.innerText = dades.length;
            if (dades.length > 0) btnSync.style.display = 'block';
            else {
                btnSync.style.display = 'none';
                llistaRegistres.innerHTML = '<p style="color:gray; font-size:12px;">Cap allau pendent.</p>';
            }
        }

        // --- GUARDAR REAL ---
        document.getElementById('btn-guardar').addEventListener('click', async () => {
            const lloc = document.getElementById('input-lloc').value;
            const mida = document.getElementById('input-mida').value;
            const tipus = document.getElementById('input-tipus').value; // Llegim el nou camp

            if (latitudActual === null) { alert("Si us plau, captura primer la ubicaci√≥."); return; }
            if (lloc === "") { alert("Escriu el nom del sector."); return; }
            if (fotoBase64 === null) { alert("Si us plau, fes una fotografia de l'allau."); return; }

            // Afegim el tipus a l'objecte que guardarem
            const novaAllau = {
                lloc: lloc,
                mida: mida,
                tipus: tipus,
                lat: latitudActual,
                lon: longitudActual,
                foto: fotoBase64,
                data: new Date().toLocaleString()
            };

            const dades = await localforage.getItem('allaus_pendents') || [];
            dades.push(novaAllau);
            await localforage.setItem('allaus_pendents', dades); 

            // Netegem el formulari
            document.getElementById('input-lloc').value = "";
            // Tornem els desplegables al primer valor per defecte
            document.getElementById('input-mida').selectedIndex = 0;
            document.getElementById('input-tipus').selectedIndex = 0;
            
            latitudActual = null; longitudActual = null; fotoBase64 = null;
            document.getElementById('coords-info').innerText = "Coordenades no capturades encara.";
            document.getElementById('preview-foto').style.display = 'none';
            if (marcador) map.removeLayer(marcador);
            
            carregarDadesLocals();
            alert("‚úÖ Guardat al tel√®fon amb √®xit!");
        });

        // --- SINCRONITZAR ---
        btnSync.addEventListener('click', async () => {
            if (!navigator.onLine) { alert("‚ùå No tens internet per sincronitzar."); return; }
            btnSync.innerText = "‚è≥ Enviant...";
            
            setTimeout(async () => {
                await localforage.removeItem('allaus_pendents');
                carregarDadesLocals();
                btnSync.innerText = "üì° Sincronitzar amb Servidor";
                alert("üöÄ Dades enviades a la UPAN!");
            }, 1500);
        });

        carregarDadesLocals();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>

