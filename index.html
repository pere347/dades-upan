<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPAN - Registre d'Allaus</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 15px; max-width: 500px; margin: auto; }
        
        /* Estils del mapa */
        #map { height: 300px; width: 100%; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ddd; z-index: 1; }
        
        .camp { margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
        
        .btn { padding: 15px; font-size: 16px; border: none; border-radius: 8px; width: 100%; cursor: pointer; color: white; font-weight: bold; margin-bottom: 10px; }
        .btn-gps { background-color: #3498db; }
        .btn-guardar { background-color: #f39c12; }
        
        #coords-info { font-size: 12px; color: #555; text-align: center; margin-bottom: 15px; }
    </style>
</head>
<body>

    <h2>üèîÔ∏è Reportar Allau (UPAN)</h2>

    <div id="map"></div>
    
    <button id="btn-gps" class="btn btn-gps">üìç Capturar la meva ubicaci√≥</button>
    <div id="coords-info">Coordenades no capturades encara.</div>

    <div class="camp">
        <label>Nom del sector / Lloc:</label>
        <input type="text" id="input-lloc" placeholder="Ex: Pala d'Eixe">
    </div>
    <div class="camp">
        <label>Mida de l'allau:</label>
        <select id="input-mida">
            <option value="D1">D1 (Petita)</option>
            <option value="D2">D2 (Mitjana)</option>
            <option value="D3">D3 (Gran)</option>
        </select>
    </div>

    <button id="btn-guardar" class="btn btn-guardar">üíæ Guardar Dades Temporals</button>

    <script>
        // Variables globals per guardar les coordenades
        let latitudActual = null;
        let longitudActual = null;

        // 1. INICIALITZAR EL MAPA
        // Centrem per defecte al mig dels Pirineus catalans amb un zoom lluny√†
        const map = L.map('map').setView([42.5, 1.5], 8);

        // Afegim la capa Topogr√†fica de l'ICGC (URL Actualitzada)
        L.tileLayer('https://geoserveis.icgc.cat/servei/catalunya/mapa-base/wmts/topografic/MON3857NW/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© ICGC'
        }).addTo(map);

        // TRUC EXTRA: Aix√≤ for√ßa el mapa a redibuixar-se b√© a les pantalles de m√≤bil
        setTimeout(() => { map.invalidateSize(); }, 500);

        // Variable per a la xinxeta (marcador)
        let marcador;

        // 2. FUNCI√ì PER CAPTURAR EL GPS
        document.getElementById('btn-gps').addEventListener('click', () => {
            const infoDiv = document.getElementById('coords-info');
            
            if (!navigator.geolocation) {
                infoDiv.innerHTML = "<span style='color:red;'>El teu navegador no suporta GPS.</span>";
                return;
            }

            infoDiv.innerText = "Buscant sat√®l¬∑lits... üõ∞Ô∏è";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Guardem les coordenades a les variables globals
                    latitudActual = position.coords.latitude;
                    longitudActual = position.coords.longitude;
                    const precisio = position.coords.accuracy;

                    // Mostrem el text
                    infoDiv.innerHTML = `‚úÖ Precisi√≥: ¬±${Math.round(precisio)} metres (Lat: ${latitudActual.toFixed(5)}, Lon: ${longitudActual.toFixed(5)})`;

                    // Movem el mapa a la ubicaci√≥ de l'usuari amb zoom proper (nivell 15)
                    map.setView([latitudActual, longitudActual], 15);

                    // Si ja hi havia una xinxeta d'abans, l'esborrem
                    if (marcador) {
                        map.removeLayer(marcador);
                    }

                    // Afegim la nova xinxeta
                    marcador = L.marker([latitudActual, longitudActual]).addTo(map);
                },
                (error) => {
                    infoDiv.innerHTML = `<span style='color:red;'>Error de GPS: Verifica que tens la ubicaci√≥ activada.</span>`;
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        });

        // 3. FUNCI√ì DE GUARDAR (De moment simulem un av√≠s)
        document.getElementById('btn-guardar').addEventListener('click', () => {
            const lloc = document.getElementById('input-lloc').value;
            
            if (latitudActual === null) {
                alert("Si us plau, captura primer la teva ubicaci√≥ amb el bot√≥ blau.");
                return;
            }
            if (lloc === "") {
                alert("Si us plau, posa un nom al lloc.");
                return;
            }

            alert(`Dades llistes per guardar!\nLloc: ${lloc}\nCoords: ${latitudActual}, ${longitudActual}`);
        });

        // Codi per registrar el Service Worker que vam fer abans
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>


